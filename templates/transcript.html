{% extends "base.html" %}

{% block title %}{% if video_title %}{{ video_title }}{% else %}{{ video_id }}{% endif %} - YouTube Deep Summary{% endblock %}

{% block content %}
    <div class="video-info">
        <div style="display: flex; align-items: flex-start; gap: 20px; margin-bottom: 20px;">
            <div style="flex-shrink: 0;">
                <img src="{{ thumbnail_url }}" 
                     alt="Video thumbnail" 
                     style="width: 320px; height: 180px; object-fit: cover; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                     onerror="this.style.display='none'">
            </div>
            <div style="flex-grow: 1;">
                {% if video_title %}
                    <h2>{{ video_title }}</h2>
                    <p style="color: #666; margin: 5px 0;">
                        {% if channel_info and channel_info.handle %}
                            <strong><a href="/@{{ channel_info.handle }}" style="color: #0066cc; text-decoration: none;">{{ channel_info.channel_name or 'Unknown Channel' }}</a></strong>
                        {% elif channel_info and channel_info.channel_name %}
                            <strong><a href="/channels" style="color: #0066cc; text-decoration: none;">{{ channel_info.channel_name }}</a></strong>
                        {% else %}
                            <strong><a href="/channels" style="color: #0066cc; text-decoration: none;">Unknown Channel</a></strong>
                        {% endif %}
                        {% if video_duration %} ‚Ä¢ {{ "%.0f"|format(video_duration // 60) }}:{{ "%02.0f"|format(video_duration % 60) }} minutes{% endif %}
                    </p>
                {% else %}
                    <h2>üì∫ Video ID: {{ video_id }}</h2>
                {% endif %}
                <p><strong>YouTube URL:</strong> <a href="https://www.youtube.com/watch?v={{ video_id }}" target="_blank">https://www.youtube.com/watch?v={{ video_id }}</a></p>
                <p style="margin-top: 10px;">
                    <a href="https://www.youtube.com/watch?v={{ video_id }}" target="_blank" style="background: #ff0000; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px; display: inline-block; margin-right: 10px;">‚ñ∂Ô∏è Watch on YouTube</a>
                    {% if summarize_enabled %}
                        <button id="generateSummaryBtn" onclick="generateSummary('{{ video_id }}')" style="background: #2196f3; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; display: inline-block;">ü§ñ {% if summary %}Regenerate AI Summary{% else %}Generate AI Summary{% endif %}</button>
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
    
    <!-- Proxy info hidden 
    <div class="proxy-info">
        <strong>üåê Proxy used:</strong> {{ proxy_used }}
    </div>
    -->
    
    <details class="search-form-collapsed" style="margin-bottom: 20px;">
        <summary style="background: #f8f9fa; padding: 10px 15px; border-radius: 5px; cursor: pointer; border: 1px solid #ddd; outline: none;">
            üîç Search Another Video
        </summary>
        <div class="search-form" style="margin-top: 10px; border-top: 1px solid #ddd; padding-top: 15px;">
            <form action="/watch" method="get">
                <input type="text" name="v" placeholder="Enter another video ID or URL" value="{{ video_id }}">
                <button type="submit">Get Transcript</button>
                {% if summarize_enabled %}
                    <label style="margin-left: 10px;">
                        <input type="checkbox" name="summarize" value="true" {% if summary or summary_error %}checked{% endif %}>
                        Generate AI Summary
                    </label>
                {% endif %}
            </form>
        </div>
    </details>
    
    <!-- Generate AI Summary button moved to video info section -->
    
    <!-- Summary section - will be populated by JavaScript or shown if pre-loaded -->
    <div id="summary-section" style="{% if not summary and not summary_error %}display: none;{% endif %}">
        {% if summary %}
            <div class="summary-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                    <h3 style="margin: 0;">ü§ñ AI-Generated Summary:</h3>
                    {% if summarize_enabled %}
                        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                            <select id="modelSelect" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; background: white;">
                                <option value="">Loading models...</option>
                            </select>
                            <button id="regenerateSummaryBtn" onclick="regenerateSummaryWithModel('{{ video_id }}')" style="background: #ff9800; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">üîÑ Regenerate</button>
                        </div>
                    {% endif %}
                </div>
                <div class="summary-content">
                    <div class="markdown-content">{{ summary|safe }}</div>
                </div>
            </div>
            <hr style="margin: 30px 0; border: 1px solid #ddd;">
        {% endif %}
        
        {% if summary_error %}
            <div class="summary-error">
                <h3>‚ùå Summary Error:</h3>
                <p style="color: #d32f2f;">{{ summary_error }}</p>
            </div>
            <hr style="margin: 30px 0; border: 1px solid #ddd;">
        {% endif %}
    </div>
    
    {% if chapters %}
        <div class="chapters-info">
            <h3>üìö Video Chapters ({{ chapters|length }} chapters):</h3>
            <ul style="background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 10px 0;">
                {% for chapter in chapters %}
                    <li><strong>{{ chapter.title }}</strong> - <a href="#chapter-{{ chapter.time|int }}" onclick="scrollToChapter({{ chapter.time|int }})" style="color: #0066cc; text-decoration: underline; cursor: pointer;">{{ "%.0f"|format(chapter.time // 60) }}:{{ "%02.0f"|format(chapter.time % 60) }}</a> <span style="color: #666; font-size: 0.9em;">(<a href="https://www.youtube.com/watch?v={{ video_id }}&t={{ chapter.time|int }}s" target="_blank" style="color: #999; text-decoration: none;" title="Watch on YouTube">‚ñ∂Ô∏è</a>)</span></li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}
    
    <div class="transcript-options" style="margin: 20px 0;">
        <button onclick="toggleTranscriptView()" id="toggleBtn" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 10px;">
            üìñ Switch to Detailed View
        </button>
        <button onclick="copyTranscriptToClipboard()" id="copyBtn" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
            üìã Copy Transcript
        </button>
    </div>
    
    <h3>üìù Transcript ({{ transcript|length }} entries):</h3>
    
    <!-- Formatted readable transcript (default view) -->
    <div id="formatted-transcript" class="transcript-container" style="display: block;">
        <div class="formatted-text" style="background: #f9f9f9; padding: 15px; border-radius: 5px; line-height: 1.6; font-family: Georgia, serif;">
            <div id="formatted-transcript-content" style="white-space: pre-wrap; font-family: Georgia, serif; margin: 0;">{{ formatted_transcript|safe }}</div>
        </div>
    </div>
    
    <!-- Detailed timestamp transcript (hidden by default) -->
    <div id="detailed-transcript" class="transcript-container" style="display: none;">
        {% for entry in transcript %}
            <div class="transcript-entry" data-time="{{ entry.time|int }}" id="timestamp-{{ entry.time|int }}">
                <div class="timestamp">[{{ entry.formatted_time }}] ({{ "%.2f"|format(entry.time) }}s)</div>
                <div class="text">{{ entry.text }}</div>
            </div>
        {% endfor %}
    </div>
    
    <script>
        function toggleTranscriptView() {
            const formattedDiv = document.getElementById('formatted-transcript');
            const detailedDiv = document.getElementById('detailed-transcript');
            const toggleBtn = document.getElementById('toggleBtn');
            
            if (formattedDiv.style.display === 'none') {
                // Show formatted, hide detailed
                formattedDiv.style.display = 'block';
                detailedDiv.style.display = 'none';
                toggleBtn.textContent = 'üìñ Switch to Detailed View';
            } else {
                // Show detailed, hide formatted
                formattedDiv.style.display = 'none';
                detailedDiv.style.display = 'block';
                toggleBtn.textContent = 'üìÑ Switch to Readable View';
            }
        }
        
        function scrollToChapter(chapterTime) {
            const formattedDiv = document.getElementById('formatted-transcript');
            const detailedDiv = document.getElementById('detailed-transcript');
            const chapterId = 'chapter-' + chapterTime;
            
            if (formattedDiv.style.display !== 'none') {
                // In formatted view - scroll to the chapter anchor
                const chapterAnchor = document.getElementById(chapterId);
                if (chapterAnchor) {
                    chapterAnchor.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    
                    // Highlight the section temporarily
                    const formattedContent = document.getElementById('formatted-transcript-content');
                    const originalBg = formattedContent.parentElement.style.backgroundColor;
                    formattedContent.parentElement.style.backgroundColor = '#fff3cd';
                    setTimeout(() => {
                        formattedContent.parentElement.style.backgroundColor = originalBg;
                    }, 2000);
                } else {
                    // Fallback: scroll to formatted transcript
                    const formattedContent = document.getElementById('formatted-transcript-content');
                    formattedContent.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            } else {
                // In detailed view - find the closest timestamp entry
                const timestampEntries = document.querySelectorAll('.transcript-entry[data-time]');
                let closestEntry = null;
                let closestDiff = Infinity;
                
                timestampEntries.forEach(entry => {
                    const entryTime = parseInt(entry.getAttribute('data-time'));
                    const diff = Math.abs(entryTime - chapterTime);
                    if (diff < closestDiff) {
                        closestDiff = diff;
                        closestEntry = entry;
                    }
                });
                
                if (closestEntry) {
                    closestEntry.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    
                    // Highlight the entry temporarily
                    const originalBg = closestEntry.style.backgroundColor;
                    closestEntry.style.backgroundColor = '#fff3cd';
                    closestEntry.style.borderLeft = '4px solid #ffc107';
                    closestEntry.style.paddingLeft = '10px';
                    setTimeout(() => {
                        closestEntry.style.backgroundColor = originalBg;
                        closestEntry.style.borderLeft = '';
                        closestEntry.style.paddingLeft = '';
                    }, 2000);
                }
            }
        }
        
        function convertMarkdownToHtml(markdown) {
            let html = markdown;
            
            // Convert headers (## Header -> <h2>Header</h2>)
            html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
            html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
            html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
            
            // Convert **bold** to <strong>bold</strong>
            html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            
            // Convert *italic* to <em>italic</em>
            html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            
            // Convert [text](url) to <a href="url" target="_blank">text</a>
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
            
            // Convert bullet lists (- item or * item)
            html = html.replace(/^[-*] (.+)$/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
            
            // Convert numbered lists (1. item)
            html = html.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
            
            // Convert line breaks to paragraphs
            html = html.replace(/\n\n/g, '</p><p>');
            html = '<p>' + html + '</p>';
            
            // Clean up empty paragraphs
            html = html.replace(/<p><\/p>/g, '');
            html = html.replace(/<p>(<h[1-6]>)/g, '$1');
            html = html.replace(/(<\/h[1-6]>)<\/p>/g, '$1');
            html = html.replace(/<p>(<ul>)/g, '$1');
            html = html.replace(/(<\/ul>)<\/p>/g, '$1');
            
            return html;
        }
        
        function generateSummary(videoId) {
            const btn = document.getElementById('generateSummaryBtn');
            const summarySection = document.getElementById('summary-section');
            
            // Get formatted transcript text (readable version, not detailed timestamps)
            const formattedTranscript = {{ formatted_transcript|tojson }};
            
            // Update button to show loading state
            btn.textContent = '‚è≥ Generating...';
            btn.disabled = true;
            btn.style.background = '#666';
            
            // Make AJAX request to generate summary with formatted transcript
            fetch('/api/summary', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    video_id: videoId,
                    formatted_transcript: formattedTranscript,
                    force_regenerate: false
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Convert markdown to HTML
                        const summaryHtml = convertMarkdownToHtml(data.summary);
                        
                        // Show summary section
                        summarySection.style.display = 'block';
                        summarySection.innerHTML = `
                            <div class="summary-section">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h3 style="margin: 0;">ü§ñ AI-Generated Summary:</h3>
                                    <button id="regenerateSummaryBtn" onclick="regenerateSummary('${videoId}')" style="background: #ff9800; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">üîÑ Regenerate</button>
                                </div>
                                <div class="summary-content">
                                    <div class="markdown-content">${summaryHtml}</div>
                                </div>
                            </div>
                            <hr style="margin: 30px 0; border: 1px solid #ddd;">
                        `;
                        
                        // Add H2 snippet icons to the new summary
                        setTimeout(addH2SnippetIcons, 100);
                        
                        // Update the button text to indicate it can regenerate
                        btn.textContent = 'ü§ñ Regenerate AI Summary';
                        btn.disabled = false;
                        btn.style.background = '#2196f3';
                    } else {
                        // Show error
                        summarySection.style.display = 'block';
                        summarySection.innerHTML = `
                            <div class="summary-error">
                                <h3>‚ùå Summary Error:</h3>
                                <p style="color: #d32f2f;">${data.error}</p>
                            </div>
                            <hr style="margin: 30px 0; border: 1px solid #ddd;">
                        `;
                        
                        // Reset button
                        btn.textContent = 'ü§ñ Generate AI Summary';
                        btn.disabled = false;
                        btn.style.background = '#2196f3';
                    }
                })
                .catch(error => {
                    // Show error
                    summarySection.style.display = 'block';
                    summarySection.innerHTML = `
                        <div class="summary-error">
                            <h3>‚ùå Summary Error:</h3>
                            <p style="color: #d32f2f;">Failed to generate summary: ${error.message}</p>
                        </div>
                        <hr style="margin: 30px 0; border: 1px solid #ddd;">
                    `;
                    
                    // Reset button
                    btn.textContent = 'ü§ñ Generate AI Summary';
                    btn.disabled = false;
                    btn.style.background = '#2196f3';
                });
        }
        
        function regenerateSummary(videoId) {
            const btn = document.getElementById('regenerateSummaryBtn');
            const summarySection = document.getElementById('summary-section');
            
            // Get formatted transcript text (readable version, not detailed timestamps)
            const formattedTranscript = {{ formatted_transcript|tojson }};
            
            // Update button to show loading state
            btn.textContent = '‚è≥ Regenerating...';
            btn.disabled = true;
            btn.style.background = '#666';
            
            // Make AJAX request to generate summary with formatted transcript
            fetch('/api/summary', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    video_id: videoId,
                    formatted_transcript: formattedTranscript,
                    force_regenerate: true
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Convert markdown to HTML
                        const summaryHtml = convertMarkdownToHtml(data.summary);
                        
                        // Update summary section with new content
                        summarySection.innerHTML = `
                            <div class="summary-section">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h3 style="margin: 0;">ü§ñ AI-Generated Summary:</h3>
                                    <button id="regenerateSummaryBtn" onclick="regenerateSummary('${videoId}')" style="background: #ff9800; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">üîÑ Regenerate</button>
                                </div>
                                <div class="summary-content">
                                    <div class="markdown-content">${summaryHtml}</div>
                                </div>
                            </div>
                            <hr style="margin: 30px 0; border: 1px solid #ddd;">
                        `;
                        
                        // Add H2 snippet icons to the regenerated summary
                        setTimeout(addH2SnippetIcons, 100);
                        
                        // Update the main generate button
                        const mainBtn = document.getElementById('generateSummaryBtn');
                        if (mainBtn) {
                            mainBtn.textContent = 'ü§ñ Regenerate AI Summary';
                            mainBtn.disabled = false;
                            mainBtn.style.background = '#2196f3';
                        }
                    } else {
                        // Show error but keep the regenerate button
                        summarySection.innerHTML = `
                            <div class="summary-error">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h3 style="margin: 0;">‚ùå Summary Error:</h3>
                                    <button id="regenerateSummaryBtn" onclick="regenerateSummary('${videoId}')" style="background: #ff9800; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">üîÑ Regenerate</button>
                                </div>
                                <p style="color: #d32f2f;">${data.error}</p>
                            </div>
                            <hr style="margin: 30px 0; border: 1px solid #ddd;">
                        `;
                    }
                })
                .catch(error => {
                    // Show error but keep the regenerate button
                    summarySection.innerHTML = `
                        <div class="summary-error">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="margin: 0;">‚ùå Summary Error:</h3>
                                <button id="regenerateSummaryBtn" onclick="regenerateSummary('${videoId}')" style="background: #ff9800; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">üîÑ Regenerate</button>
                            </div>
                            <p style="color: #d32f2f;">Failed to generate summary: ${error.message}</p>
                        </div>
                        <hr style="margin: 30px 0; border: 1px solid #ddd;">
                                            `;
                });
        }
        
        // Load available models for regeneration
        function loadAvailableModels() {
            fetch('/api/models')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.models) {
                        const modelSelect = document.getElementById('modelSelect');
                        if (modelSelect) {
                            // Clear loading option
                            modelSelect.innerHTML = '';
                            
                            // Add providers and models
                            for (const [provider, models] of Object.entries(data.models)) {
                                const optgroup = document.createElement('optgroup');
                                optgroup.label = provider.charAt(0).toUpperCase() + provider.slice(1);
                                
                                models.forEach(model => {
                                    const option = document.createElement('option');
                                    option.value = model;
                                    option.textContent = model;
                                    
                                    // Default to Claude Sonnet 4 if available
                                    if (model === 'claude-sonnet-4-20250514') {
                                        option.selected = true;
                                    }
                                    
                                    optgroup.appendChild(option);
                                });
                                
                                modelSelect.appendChild(optgroup);
                            }
                            
                            // If no Claude model available, select first available model
                            if (modelSelect.selectedIndex === -1 && modelSelect.options.length > 0) {
                                modelSelect.selectedIndex = 0;
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading models:', error);
                    const modelSelect = document.getElementById('modelSelect');
                    if (modelSelect) {
                        modelSelect.innerHTML = '<option value="">Error loading models</option>';
                    }
                });
        }
        
        // Regenerate summary with selected model
        function regenerateSummaryWithModel(videoId) {
            const btn = document.getElementById('regenerateSummaryBtn');
            const modelSelect = document.getElementById('modelSelect');
            const summarySection = document.getElementById('summary-section');
            
            const selectedModel = modelSelect.value;
            if (!selectedModel) {
                alert('Please select a model first');
                return;
            }
            
            // Update button to show loading state
            btn.textContent = '‚è≥ Regenerating...';
            btn.disabled = true;
            btn.style.background = '#666';
            
            // Make AJAX request to regenerate summary with selected model
            fetch('/api/summary/regenerate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    video_id: videoId,
                    model: selectedModel
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update summary section with new content
                        summarySection.innerHTML = `
                            <div class="summary-section">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                                    <h3 style="margin: 0;">ü§ñ AI-Generated Summary: <small style="color: #666; font-weight: normal;">(${selectedModel})</small></h3>
                                    <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                        <select id="modelSelect" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; background: white;">
                                            <option value="">Loading models...</option>
                                        </select>
                                        <button id="regenerateSummaryBtn" onclick="regenerateSummaryWithModel('${videoId}')" style="background: #ff9800; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">üîÑ Regenerate</button>
                                    </div>
                                </div>
                                <div class="summary-content">
                                    <div class="markdown-content">${data.summary}</div>
                                </div>
                            </div>
                            <hr style="margin: 30px 0; border: 1px solid #ddd;">
                        `;
                        
                        // Reload models for the new dropdown
                        loadAvailableModels();
                        
                        // Add H2 snippet icons to the regenerated summary
                        setTimeout(addH2SnippetIcons, 100);
                        
                        // Update the main generate button
                        const mainBtn = document.getElementById('generateSummaryBtn');
                        if (mainBtn) {
                            mainBtn.textContent = 'ü§ñ Regenerate AI Summary';
                            mainBtn.disabled = false;
                            mainBtn.style.background = '#2196f3';
                        }
                    } else {
                        // Show error and restore controls
                        alert('Error regenerating summary: ' + data.error);
                        btn.textContent = 'üîÑ Regenerate';
                        btn.disabled = false;
                        btn.style.background = '#ff9800';
                    }
                })
                .catch(error => {
                    console.error('Error regenerating summary:', error);
                    alert('Failed to regenerate summary: ' + error.message);
                    btn.textContent = 'üîÑ Regenerate';
                    btn.disabled = false;
                    btn.style.background = '#ff9800';
                });
        }
        
        function copyTranscriptToClipboard() {
            const formattedDiv = document.getElementById('formatted-transcript');
            const detailedDiv = document.getElementById('detailed-transcript');
            const copyBtn = document.getElementById('copyBtn');
            
            let textToCopy = '';
            
            // Check which view is currently visible
            const formattedVisible = formattedDiv.style.display !== 'none';
            
            if (formattedVisible) {
                // Copy formatted transcript (readable view)
                const formattedContent = document.getElementById('formatted-transcript-content');
                textToCopy = formattedContent.textContent || formattedContent.innerText;
            } else {
                // Copy detailed transcript (timestamped view)
                const transcriptEntries = document.querySelectorAll('#detailed-transcript .transcript-entry');
                const transcriptLines = [];
                
                transcriptEntries.forEach(entry => {
                    const timestamp = entry.querySelector('.timestamp').textContent;
                    const text = entry.querySelector('.text').textContent;
                    transcriptLines.push(`${timestamp} ${text}`);
                });
                
                textToCopy = transcriptLines.join('\n');
            }
            
            // Fallback function for older browsers or HTTP connections
            function fallbackCopyTextToClipboard(text) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.top = '-999px';
                textArea.style.left = '-999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textArea);
                    return successful;
                } catch (err) {
                    console.error('Fallback copy failed:', err);
                    document.body.removeChild(textArea);
                    return false;
                }
            }
            
            // Function to show success feedback
            function showSuccessFeedback() {
                const originalText = copyBtn.textContent;
                const originalBg = copyBtn.style.background;
                copyBtn.textContent = '‚úÖ Copied!';
                copyBtn.style.background = '#28a745';
                
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.style.background = originalBg;
                }, 2000);
            }
            
            // Function to show error feedback
            function showErrorFeedback(errorMsg) {
                console.error('Copy failed:', errorMsg);
                const originalText = copyBtn.textContent;
                const originalBg = copyBtn.style.background;
                copyBtn.textContent = '‚ùå Copy failed';
                copyBtn.style.background = '#dc3545';
                
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.style.background = originalBg;
                }, 2000);
            }
            
            // Try modern clipboard API first
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(textToCopy).then(() => {
                    showSuccessFeedback();
                }).catch(err => {
                    // If modern API fails, try fallback
                    console.log('Modern clipboard API failed, trying fallback...');
                    if (fallbackCopyTextToClipboard(textToCopy)) {
                        showSuccessFeedback();
                    } else {
                        showErrorFeedback('Both clipboard methods failed');
                    }
                });
            } else {
                // Use fallback method directly
                if (fallbackCopyTextToClipboard(textToCopy)) {
                    showSuccessFeedback();
                } else {
                    showErrorFeedback('Clipboard not supported in this browser');
                }
            }
        }
        
        // Snippets functionality
        let saveSnippetModal = null;
        let selectedText = '';
        let contextBefore = '';
        let contextAfter = '';
        let buttonClickInProgress = false;
        let selectionTimeout = null;
        let buttonCreateTime = 0;
        let lastSaveTime = 0;
        
        function initializeSnippets() {
            // Listen for text selection in summary content
            document.addEventListener('mouseup', handleTextSelection);
            document.addEventListener('keyup', handleTextSelection);
            
            // Create the save snippet modal
            createSaveSnippetModal();
        }
        
        function handleTextSelection() {
            // Clear any existing timeout
            if (selectionTimeout) {
                clearTimeout(selectionTimeout);
            }
            
            // Add a small delay to prevent rapid button creation/removal
            selectionTimeout = setTimeout(() => {
                const selection = window.getSelection();
                
                if (selection.toString().trim().length > 0) {
                    // Check if selection is within a summary content area or transcript content
                    const summaryContent = selection.anchorNode.parentElement.closest('.summary-content');
                    const transcriptContent = selection.anchorNode.parentElement.closest('.transcript-container');
                    
                    if (summaryContent || transcriptContent) {
                        selectedText = selection.toString().trim();
                        
                        // If selection is from summary content, also capture HTML formatting
                        if (summaryContent) {
                            const range = selection.getRangeAt(0);
                            const clonedContents = range.cloneContents();
                            const div = document.createElement('div');
                            div.appendChild(clonedContents);
                            selectedText = div.innerHTML || selectedText; // Use HTML if available, fallback to plain text
                        }
                        
                        // Get context before and after the selection
                        const range = selection.getRangeAt(0);
                        const container = summaryContent || transcriptContent;
                        getTextContext(range, container);
                        
                        // Show save snippet button
                        showSaveSnippetButton(selection);
                    }
                } else {
                    // Don't hide button if click is in progress
                    if (!buttonClickInProgress) {
                        hideSaveSnippetButton();
                    }
                }
            }, 100); // 100ms delay
        }
        
        function getTextContext(range, container) {
            const containerText = container.textContent;
            const selectionStart = containerText.indexOf(selectedText);
            
            if (selectionStart !== -1) {
                const beforeStart = Math.max(0, selectionStart - 100);
                const afterEnd = Math.min(containerText.length, selectionStart + selectedText.length + 100);
                
                contextBefore = containerText.substring(beforeStart, selectionStart).trim();
                contextAfter = containerText.substring(selectionStart + selectedText.length, afterEnd).trim();
            }
        }
        
        function showSaveSnippetButton(selection) {
            hideSaveSnippetButton(); // Remove any existing button
            
            const range = selection.getRangeAt(0);
            const rect = range.getBoundingClientRect();
            
            const button = document.createElement('button');
            button.id = 'saveSnippetBtn';
            button.innerHTML = 'üíæ Save as Snippet';
            button.style.cssText = `
                position: fixed;
                top: ${rect.bottom + 5}px;
                left: ${rect.left}px;
                background: #4CAF50;
                color: white;
                border: none;
                padding: 8px 12px;
                border-radius: 4px;
                font-size: 12px;
                cursor: pointer;
                z-index: 9999;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                white-space: nowrap;
            `;
            
            // Add event listener
            button.addEventListener('click', function(e) {
                buttonClickInProgress = true;
                e.preventDefault();
                e.stopPropagation();
                
                saveSnippetDirect();
                
                hideSaveSnippetButton();
                window.getSelection().removeAllRanges();
                setTimeout(() => { buttonClickInProgress = false; }, 100);
            });
            
            document.body.appendChild(button);
            buttonCreateTime = Date.now();
            
            // Auto-hide after 10 seconds
            setTimeout(hideSaveSnippetButton, 10000);
        }
        
        function hideSaveSnippetButton() {
            const existingButton = document.getElementById('saveSnippetBtn');
            if (existingButton) {
                // Don't remove the button if it was created less than 2 seconds ago
                const timeSinceCreation = Date.now() - buttonCreateTime;
                if (timeSinceCreation < 2000) {
                    return;
                }
                existingButton.remove();
            }
        }
        
        function createSaveSnippetModal() {
            const modal = document.createElement('div');
            modal.id = 'saveSnippetModal';
            modal.style.cssText = `
                display: none;
                position: fixed;
                z-index: 1001;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
            `;
            
            modal.innerHTML = `
                <div style="background: white; margin: 5% auto; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px;">
                    <h3 style="margin-top: 0;">üíæ Save Snippet</h3>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Selected Text:</label>
                        <div id="selectedTextPreview" style="background: #f5f5f5; padding: 10px; border-radius: 4px; max-height: 100px; overflow-y: auto; font-style: italic;"></div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Tags (optional):</label>
                        <input type="text" id="snippetTags" placeholder="Enter tags separated by commas" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <small style="color: #666;">e.g., important, strategy, action-item</small>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="closeSaveSnippetModal()" style="background: #ccc; color: #333; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Cancel</button>
                        <button onclick="saveSnippet()" style="background: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Save Snippet</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            saveSnippetModal = modal;
            
            // Close modal when clicking outside
            modal.onclick = function(e) {
                if (e.target === modal) {
                    closeSaveSnippetModal();
                }
            };
        }
        
        function openSaveSnippetModal() {
            if (!saveSnippetModal) {
                createSaveSnippetModal();
            }
            
            // Show formatted text in preview if it contains HTML, otherwise show as text
            const previewElement = document.getElementById('selectedTextPreview');
            if (selectedText.includes('<') && selectedText.includes('>')) {
                previewElement.innerHTML = selectedText;
            } else {
                previewElement.textContent = selectedText;
            }
            
            document.getElementById('snippetTags').value = '';
            saveSnippetModal.style.display = 'block';
        }
        
        function closeSaveSnippetModal() {
            if (saveSnippetModal) {
                saveSnippetModal.style.display = 'none';
            }
        }
        
        function saveSnippet() {
            const tags = document.getElementById('snippetTags').value
                .split(',')
                .map(tag => tag.trim())
                .filter(tag => tag.length > 0);
            
            const data = {
                video_id: '{{ video_id }}',
                snippet_text: selectedText, // selectedText now contains HTML formatting when from summary
                context_before: contextBefore,
                context_after: contextAfter,
                tags: tags
            };
            
            fetch('/api/snippets', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeSaveSnippetModal();
                    // Show a brief success indicator
                    const successMsg = document.createElement('div');
                    successMsg.textContent = '‚úì Snippet saved';
                    successMsg.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #4CAF50;
                        color: white;
                        padding: 10px 20px;
                        border-radius: 5px;
                        z-index: 10000;
                        font-size: 14px;
                    `;
                    document.body.appendChild(successMsg);
                    setTimeout(() => successMsg.remove(), 3000);
                }
            })
            .catch(error => {
                // Silent error handling
            });
        }
        
        function saveSnippetDirect() {
            // Prevent duplicate saves within 2 seconds
            const now = Date.now();
            if (now - lastSaveTime < 2000) {
                return;
            }
            lastSaveTime = now;
            
            const data = {
                video_id: '{{ video_id }}',
                snippet_text: selectedText, // selectedText now contains HTML formatting when from summary
                context_before: contextBefore,
                context_after: contextAfter,
                tags: [] // No tags when saving directly
            };
            
            fetch('/api/snippets', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show a brief success indicator
                    const successMsg = document.createElement('div');
                    successMsg.textContent = '‚úì Snippet saved';
                    successMsg.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #4CAF50;
                        color: white;
                        padding: 10px 20px;
                        border-radius: 5px;
                        z-index: 10000;
                        font-size: 14px;
                    `;
                    document.body.appendChild(successMsg);
                    setTimeout(() => successMsg.remove(), 3000);
                }
            })
            .catch(error => {
                // Silent error handling
            });
        }
        
        
        // H2 Section Snippet Functionality
        function addH2SnippetIcons() {
            // Find all H2 elements in markdown content
            const h2Elements = document.querySelectorAll('.markdown-content h2');
            
            h2Elements.forEach((h2, index) => {
                // Skip if icon already exists
                if (h2.querySelector('.h2-snippet-icon')) {
                    return;
                }
                
                // Create snippet icon
                const icon = document.createElement('span');
                icon.className = 'h2-snippet-icon';
                icon.innerHTML = 'üíæ';
                icon.title = 'Save this section as snippet';
                icon.setAttribute('data-h2-index', index);
                
                // Add click handler
                icon.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    saveH2Section(h2, index);
                });
                
                // Append icon to H2
                h2.appendChild(icon);
            });
        }

        function saveH2Section(h2Element, sectionIndex) {
            // Get the H2 section content (everything until the next H2 or end of content)
            const sectionContent = getH2SectionContent(h2Element);
            
            if (!sectionContent.trim()) {
                // Show error message
                const errorMsg = document.createElement('div');
                errorMsg.textContent = '‚ö†Ô∏è No content found in this section';
                errorMsg.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #ff4444;
                    color: white;
                    padding: 10px 20px;
                    border-radius: 5px;
                    z-index: 10000;
                    font-size: 14px;
                `;
                document.body.appendChild(errorMsg);
                setTimeout(() => errorMsg.remove(), 3000);
                return;
            }
            
            // Prevent duplicate saves within 2 seconds
            const now = Date.now();
            if (now - lastSaveTime < 2000) {
                return;
            }
            lastSaveTime = now;
            
            // Get section title for context
            const sectionTitle = h2Element.textContent.replace('üíæ', '').trim();
            
            const data = {
                video_id: '{{ video_id }}',
                snippet_text: sectionContent,
                context_before: '',
                context_after: '',
                tags: []
            };
            
            // Show loading state
            const originalIcon = h2Element.querySelector('.h2-snippet-icon');
            const originalContent = originalIcon.innerHTML;
            originalIcon.innerHTML = '‚è≥';
            originalIcon.style.background = '#666';
            
            fetch('/api/snippets', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success indicator
                    const successMsg = document.createElement('div');
                    successMsg.textContent = `‚úì Section "${sectionTitle}" saved as snippet`;
                    successMsg.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #4CAF50;
                        color: white;
                        padding: 10px 20px;
                        border-radius: 5px;
                        z-index: 10000;
                        font-size: 14px;
                        max-width: 300px;
                    `;
                    document.body.appendChild(successMsg);
                    setTimeout(() => successMsg.remove(), 3000);
                    
                    // Animate icon to show success
                    originalIcon.innerHTML = '‚úì';
                    originalIcon.style.background = '#4CAF50';
                    originalIcon.style.color = 'white';
                    setTimeout(() => {
                        originalIcon.innerHTML = originalContent;
                        originalIcon.style.background = '';
                        originalIcon.style.color = '';
                    }, 2000);
                } else {
                    throw new Error(data.message || 'Failed to save snippet');
                }
            })
            .catch(error => {
                // Show error message
                const errorMsg = document.createElement('div');
                errorMsg.textContent = `‚ùå Failed to save section: ${error.message}`;
                errorMsg.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #ff4444;
                    color: white;
                    padding: 10px 20px;
                    border-radius: 5px;
                    z-index: 10000;
                    font-size: 14px;
                `;
                document.body.appendChild(errorMsg);
                setTimeout(() => errorMsg.remove(), 3000);
                
                // Reset icon
                originalIcon.innerHTML = originalContent;
                originalIcon.style.background = '';
                originalIcon.style.color = '';
            });
        }

        function getH2SectionContent(h2Element) {
            let content = '';
            let currentElement = h2Element.nextElementSibling;
            
            // Include the H2 title itself, but remove the snippet icon
            const h2Clone = h2Element.cloneNode(true);
            const iconElement = h2Clone.querySelector('.h2-snippet-icon');
            if (iconElement) {
                iconElement.remove();
            }
            content += h2Clone.outerHTML;
            
            // Traverse siblings until we hit another H2 or end of content
            while (currentElement) {
                // Stop if we encounter another H2
                if (currentElement.tagName === 'H2') {
                    break;
                }
                
                // Add the element's HTML content
                content += currentElement.outerHTML;
                currentElement = currentElement.nextElementSibling;
            }
            
            return content;
        }
        
        // Initialize snippets functionality when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeSnippets();
            addH2SnippetIcons();
            loadAvailableModels(); // Load available AI models for summary regeneration
        });
    </script>
    
{% endblock %}