{% extends "base.html" %}

{% block title %}{% if video_title %}{{ video_title }}{% else %}{{ video_id }}{% endif %} - YouTube Deep Search{% endblock %}

{% block content %}
    <!-- Video Header Card -->
    <div class="card video-info" style="margin-bottom: 24px;">
        <div class="card-body">
            <div style="display: flex; gap: 20px;">
                <div style="flex-shrink: 0;">
                    <a href="https://www.youtube.com/watch?v={{ video_id }}" target="_blank">
                        <img src="{{ thumbnail_url }}" 
                             alt="Video thumbnail" 
                             style="width: 320px; height: 180px; object-fit: cover; border-radius: 12px; border: 1px solid var(--border-light); cursor: pointer; transition: opacity 0.2s ease;"
                             onerror="this.style.display='none'"
                             onmouseover="this.style.opacity='0.8'"
                             onmouseout="this.style.opacity='1'">
                    </a>
                </div>
                <div style="flex-grow: 1; min-width: 0;">
                    {% if video_title %}
                        <a href="https://www.youtube.com/watch?v={{ video_id }}" target="_blank" style="text-decoration: none; color: inherit;">
                            <h1 style="margin: 0 0 12px 0; font-size: 24px; font-weight: 700; line-height: 1.3; color: var(--text-primary); cursor: pointer; transition: color 0.2s ease;" onmouseover="this.style.color='var(--yt-red)'" onmouseout="this.style.color='var(--text-primary)'">{{ video_title }}</h1>
                        </a>
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px; color: var(--text-secondary);">
                            {% if video_uploader %}
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <i data-lucide="user" style="width: 16px; height: 16px;"></i>
                                    <a href="https://www.youtube.com/results?search_query={{ video_uploader|urlencode }}" target="_blank" style="color: var(--text-secondary); text-decoration: none; font-weight: 500;">{{ video_uploader }}</a>
                                </div>
                            {% endif %}
                            {% if video_duration %}
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <i data-lucide="clock" style="width: 16px; height: 16px;"></i>
                                    <span>{{ "%.0f"|format(video_duration // 60) }}:{{ "%02.0f"|format(video_duration % 60) }}</span>
                                </div>
                            {% endif %}
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <i data-lucide="file-text" style="width: 16px; height: 16px;"></i>
                                <span>{{ transcript|length }} entries</span>
                            </div>
                        </div>
                    {% else %}
                        <h1 style="margin: 0 0 16px 0; font-size: 24px; font-weight: 700; color: var(--text-primary);">Video ID: {{ video_id }}</h1>
                    {% endif %}
                    
                    <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                        <a href="https://www.youtube.com/watch?v={{ video_id }}" target="_blank" class="btn btn-primary">
                            <i data-lucide="play" class="btn-icon"></i>
                            Watch on YouTube
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Content Navigation Tabs -->
    <div style="margin-bottom: 24px;">
        <div style="display: flex; gap: 8px; border-bottom: 1px solid var(--border-light);">
            <a href="/watch?v={{ video_id }}&view=transcript" class="content-nav-item {% if request.args.get('view', 'transcript') == 'transcript' %}active{% endif %}">
                <i data-lucide="file-text" style="width: 16px; height: 16px;"></i>
                Transcript
            </a>
            {% if summarize_enabled %}
                <a href="/watch?v={{ video_id }}&view=summary" class="content-nav-item {% if request.args.get('view') == 'summary' %}active{% endif %}">
                    <i data-lucide="sparkles" style="width: 16px; height: 16px;"></i>
                    Summary
                </a>
            {% endif %}
        </div>
    </div>
    
    <!-- Summary section (only show in summary view) -->
    {% if request.args.get('view') == 'summary' %}
        {% if summarize_enabled %}
            <!-- Summary section -->
            <div id="summary-section" style="margin-bottom: 24px;">
                {% if summary %}
                    <div class="card summary-section">
                        <div class="card-header">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h3 style="margin: 0; display: flex; align-items: center; gap: 12px; font-size: 18px; font-weight: 600;">
                                    <i data-lucide="sparkles" style="width: 20px; height: 20px; color: #8b5cf6;"></i>
                                    AI-Generated Summary
                                </h3>
                                <div style="display: flex; gap: 8px;">
                                    <button onclick="copySummary()" class="btn btn-secondary" style="padding: 6px 12px; font-size: 14px;">
                                        <i data-lucide="copy" style="width: 14px; height: 14px;"></i>
                                        Copy
                                    </button>
                                    <button onclick="toggleSummary()" id="summaryToggleBtn" class="btn btn-secondary" style="padding: 6px 12px; font-size: 14px;">
                                        <i data-lucide="chevron-up" style="width: 14px; height: 14px;"></i>
                                        Collapse
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="summary-content" id="summaryContent">
                                <pre>{{ summary }}</pre>
                            </div>
                        </div>
                    </div>
                {% elif summary_error %}
                    <div class="alert alert-warning">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <i data-lucide="alert-triangle" style="width: 16px; height: 16px;"></i>
                            <strong>Summary Generation Failed</strong>
                        </div>
                        <p style="margin: 0;">{{ summary_error }}</p>
                    </div>
                {% elif summarize_enabled %}
                    <div class="card">
                        <div class="card-body" style="text-align: center; padding: 40px 20px;">
                            <div style="width: 80px; height: 80px; background: var(--light-surface); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px;">
                                <i data-lucide="sparkles" style="width: 32px; height: 32px; color: #8b5cf6;"></i>
                            </div>
                            <h3 style="margin: 0 0 12px 0; font-size: 20px; font-weight: 600; color: var(--text-primary);">No Summary Generated</h3>
                            <p style="margin: 0 0 24px 0; color: var(--text-secondary); font-size: 16px;">Generate an AI-powered summary of this video's content</p>
                            <button id="generateSummaryBtn" onclick="generateSummary('{{ video_id }}')" class="btn btn-primary">
                                <i data-lucide="sparkles" class="btn-icon"></i>
                                Generate AI Summary
                            </button>
                        </div>
                    </div>
                {% endif %}
            </div>
        {% endif %}
    {% else %}
        <!-- Hidden summary section for AJAX loading in transcript view -->
        <div id="summary-section" style="display: none;"></div>
    {% endif %}
    
    <!-- Chapters section (if any, only show in transcript view) -->
    {% if chapters and request.args.get('view', 'transcript') == 'transcript' %}
        <div class="card" style="margin-bottom: 24px;">
            <div class="card-header">
                <h4 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                    <i data-lucide="list" style="width: 16px; height: 16px; color: var(--yt-red);"></i>
                    Video Chapters ({{ chapters|length }} chapters):
                </h4>
            </div>
            <div class="card-body" style="background: var(--light-surface); padding: 20px;">
                <ul style="list-style: none; margin: 0; padding: 0;">
                    {% for chapter in chapters %}
                        <li style="margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                            <span style="color: var(--text-primary); font-weight: 500;">â€¢</span>
                            <span style="color: var(--text-primary); font-weight: 500;">{{ chapter.title }}</span>
                            <span style="color: var(--text-secondary);">-</span>
                            <a href="javascript:void(0)" onclick="jumpToTranscriptTime({{ chapter.time }})" style="color: var(--yt-red); text-decoration: underline; font-weight: 500; cursor: pointer;">
                                {{ "%.0f"|format(chapter.time // 60) }}:{{ "%02.0f"|format(chapter.time % 60) }}
                            </a>
                            <a href="https://www.youtube.com/watch?v={{ video_id }}&t={{ chapter.time|int }}s" target="_blank" style="margin-left: 4px; color: var(--text-secondary); text-decoration: none;">
                                <i data-lucide="play" style="width: 12px; height: 12px;"></i>
                            </a>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    {% endif %}
    
    <!-- Transcript Content (only show in transcript view) -->
    {% if request.args.get('view', 'transcript') == 'transcript' %}
    <div class="card">
        <div class="card-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; display: flex; align-items: center; gap: 12px; font-size: 18px; font-weight: 600;">
                    <i data-lucide="file-text" style="width: 20px; height: 20px; color: var(--yt-red);"></i>
                    Video Transcript ({{ transcript|length }} entries)
                </h3>
                <div style="display: flex; gap: 8px;">
                    <button onclick="copyTranscript()" class="btn btn-secondary" style="padding: 6px 12px; font-size: 14px;">
                        <i data-lucide="copy" style="width: 14px; height: 14px;"></i>
                        Copy
                    </button>
                    <button onclick="toggleTranscriptView()" id="toggleBtn2" class="btn btn-secondary" style="padding: 6px 12px; font-size: 14px;">
                        <i data-lucide="book-open" style="width: 14px; height: 14px;"></i>
                        Switch to Detailed View
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body" style="padding: 0;">
            <!-- Formatted readable transcript (default view) -->
            <div id="formatted-transcript" style="display: block;">
                <div style="background: var(--light-surface); padding: 24px; line-height: 1.8; font-family: Georgia, serif; font-size: 16px;">
                    <pre style="white-space: pre-wrap; font-family: Georgia, serif; margin: 0; color: var(--text-primary);">{{ formatted_transcript }}</pre>
                </div>
            </div>
            
            <!-- Detailed timestamp transcript (hidden by default) -->
            <div id="detailed-transcript" class="transcript-container" style="display: none;">
                {% for entry in transcript %}
                    <div class="transcript-entry">
                        <div class="timestamp">[{{ entry.formatted_time }}] ({{ "%.2f"|format(entry.time) }}s)</div>
                        <div class="text">{{ entry.text }}</div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
    
    <script>
        
        function toggleTranscriptView() {
            const formattedDiv = document.getElementById('formatted-transcript');
            const detailedDiv = document.getElementById('detailed-transcript');
            const toggleBtn = document.getElementById('toggleBtn');
            const toggleBtn2 = document.getElementById('toggleBtn2');
            
            if (formattedDiv.style.display === 'none') {
                // Show formatted, hide detailed
                formattedDiv.style.display = 'block';
                detailedDiv.style.display = 'none';
                
                if (toggleBtn) {
                    toggleBtn.innerHTML = '<i data-lucide="book-open" class="btn-icon"></i>Switch to Detailed View';
                }
                if (toggleBtn2) {
                    toggleBtn2.innerHTML = '<i data-lucide="book-open" style="width: 14px; height: 14px;"></i>Switch to Detailed View';
                }
            } else {
                // Show detailed, hide formatted
                formattedDiv.style.display = 'none';
                detailedDiv.style.display = 'block';
                
                if (toggleBtn) {
                    toggleBtn.innerHTML = '<i data-lucide="book-text" class="btn-icon"></i>Switch to Readable View';
                }
                if (toggleBtn2) {
                    toggleBtn2.innerHTML = '<i data-lucide="book-text" style="width: 14px; height: 14px;"></i>Switch to Readable View';
                }
            }
            
            // Reinitialize Lucide icons
            lucide.createIcons();
        }
        
        function generateSummary(videoId) {
            const btn = document.getElementById('generateSummaryBtn');
            const summarySection = document.getElementById('summary-section');
            
            // Update button to show loading state
            btn.innerHTML = '<span class="spinner"></span> Generating...';
            btn.disabled = true;
            btn.classList.add('loading');
            
            // Use the summary API endpoint that fetches its own transcript
            fetch(`/api/summary/${videoId}`, {
                method: 'GET'
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Summary API response:', data);
                    if (data.success && data.summary) {
                        // Convert markdown links and formatting to HTML
                        let summaryHtml = data.summary;
                        // Convert [text](url) to <a href="url" target="_blank">text</a>
                        summaryHtml = summaryHtml.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color: var(--yt-red); text-decoration: underline;">$1</a>');
                        // Convert **text** to <strong>text</strong>
                        summaryHtml = summaryHtml.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
                        
                        
                        // Show summary section with new design
                        summarySection.style.display = 'block';
                        summarySection.style.marginBottom = '24px';
                        summarySection.innerHTML = `
                            <div class="card summary-section">
                                <div class="card-header">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <h3 style="margin: 0; display: flex; align-items: center; gap: 12px; font-size: 18px; font-weight: 600;">
                                            <i data-lucide="sparkles" style="width: 20px; height: 20px; color: #8b5cf6;"></i>
                                            AI-Generated Summary
                                        </h3>
                                        <div style="display: flex; gap: 8px;">
                                            <button onclick="copySummary()" class="btn btn-secondary" style="padding: 6px 12px; font-size: 14px;">
                                                <i data-lucide="copy" style="width: 14px; height: 14px;"></i>
                                                Copy
                                            </button>
                                            <button onclick="toggleSummary()" id="summaryToggleBtn" class="btn btn-secondary" style="padding: 6px 12px; font-size: 14px;">
                                                <i data-lucide="chevron-up" style="width: 14px; height: 14px;"></i>
                                                Collapse
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="summary-content" id="summaryContent">
                                        <pre style="white-space: pre-wrap; word-wrap: break-word; margin: 0; font-family: inherit; color: var(--text-primary);">${summaryHtml}</pre>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // Hide the generate button
                        btn.style.display = 'none';
                        
                        // Reinitialize Lucide icons
                        lucide.createIcons();
                    } else {
                        
                        // Show error
                        summarySection.style.display = 'block';
                        summarySection.style.marginBottom = '24px';
                        summarySection.innerHTML = `
                            <div class="alert alert-warning">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <i data-lucide="alert-triangle" style="width: 16px; height: 16px;"></i>
                                    <strong>Summary Generation Failed</strong>
                                </div>
                                <p style="margin: 0;">${data.error}</p>
                            </div>
                        `;
                        
                        // Reset button
                        btn.innerHTML = '<i data-lucide="sparkles"></i>Generate AI Summary';
                        btn.disabled = false;
                        btn.classList.remove('loading');
                        
                        // Reinitialize Lucide icons
                        lucide.createIcons();
                    }
                })
                .catch(error => {
                    
                    // Show error
                    summarySection.style.display = 'block';
                    summarySection.style.marginBottom = '24px';
                    summarySection.innerHTML = `
                        <div class="alert alert-warning">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <i data-lucide="alert-triangle" style="width: 16px; height: 16px;"></i>
                                <strong>Summary Generation Failed</strong>
                            </div>
                            <p style="margin: 0;">Failed to generate summary: ${error.message}</p>
                        </div>
                    `;
                    
                    // Reset button
                    btn.innerHTML = '<i data-lucide="sparkles"></i>Generate AI Summary';
                    btn.disabled = false;
                    btn.classList.remove('loading');
                    
                    // Reinitialize Lucide icons
                    lucide.createIcons();
                });
        }
        
        function copyTranscript() {
            // Get the currently visible transcript text
            const formattedDiv = document.getElementById('formatted-transcript');
            const detailedDiv = document.getElementById('detailed-transcript');
            
            let textToCopy = '';
            
            if (formattedDiv.style.display !== 'none') {
                // Copy formatted transcript (readable version)
                const preElement = formattedDiv.querySelector('pre');
                textToCopy = preElement ? preElement.textContent : '';
            } else {
                // Copy detailed transcript with timestamps
                const entries = detailedDiv.querySelectorAll('.transcript-entry');
                const lines = [];
                entries.forEach(entry => {
                    const timestamp = entry.querySelector('.timestamp').textContent;
                    const text = entry.querySelector('.text').textContent;
                    lines.push(`${timestamp} ${text}`);
                });
                textToCopy = lines.join('\n');
            }
            
            if (textToCopy) {
                copyToClipboard(textToCopy)
                    .then(() => {
                        showCopySuccess('Transcript copied to clipboard');
                    })
                    .catch(() => {
                        showCopyError();
                    });
            }
        }
        
        function copySummary() {
            const summaryElement = document.querySelector('#summaryContent pre');
            if (summaryElement) {
                const textToCopy = summaryElement.textContent;
                copyToClipboard(textToCopy)
                    .then(() => {
                        showCopySuccess('Summary copied to clipboard');
                    })
                    .catch(() => {
                        showCopyError();
                    });
            }
        }
        
        function showCopySuccess(message) {
            // No popup - just silently copy
            console.log(message);
        }
        
        function showCopyError() {
            const content = `
                <div>
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; color: #ef4444;">
                        <i data-lucide="alert-triangle" style="width: 16px; height: 16px;"></i>
                        <span style="font-weight: 500;">Copy Failed</span>
                    </div>
                    <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px; padding: 12px;">
                        <p style="margin: 0; color: var(--text-primary); font-size: 14px; line-height: 1.4;">Unable to copy to clipboard. Please select and copy the text manually.</p>
                    </div>
                </div>
            `;
            showModal('statusModal', 'Copy Status', content);
        }
        
        function toggleSummary() {
            const summaryContent = document.getElementById('summaryContent');
            const toggleBtn = document.getElementById('summaryToggleBtn');
            
            if (summaryContent.classList.contains('summary-collapsed')) {
                summaryContent.classList.remove('summary-collapsed');
                toggleBtn.innerHTML = '<i data-lucide="chevron-up" style="width: 14px; height: 14px;"></i> Collapse';
            } else {
                summaryContent.classList.add('summary-collapsed');
                toggleBtn.innerHTML = '<i data-lucide="chevron-down" style="width: 14px; height: 14px;"></i> Expand';
            }
            lucide.createIcons();
        }
        
        function jumpToTranscriptTime(targetTime) {
            const formattedDiv = document.getElementById('formatted-transcript');
            const detailedDiv = document.getElementById('detailed-transcript');
            
            // Check if we're in formatted view
            if (formattedDiv.style.display !== 'none') {
                // Find the closest chapter anchor that's at or before the target time
                const chapterAnchors = document.querySelectorAll("a[id^='chapter-']");
                let bestAnchor = null;
                let bestTime = -1;
                
                chapterAnchors.forEach(anchor => {
                    const chapterTime = parseInt(anchor.id.replace('chapter-', ''));
                    if (chapterTime <= targetTime && chapterTime > bestTime) {
                        bestTime = chapterTime;
                        bestAnchor = anchor;
                    }
                });
                
                if (bestAnchor) {
                    bestAnchor.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                    return;
                }
            }
            
            // Fallback: Find the closest transcript entry in detailed view
            const transcriptEntries = document.querySelectorAll('.transcript-entry');
            let closestEntry = null;
            let closestTimeDiff = Infinity;
            
            transcriptEntries.forEach(entry => {
                const timestampText = entry.querySelector('.timestamp').textContent;
                // Extract time from timestamp like "[01:36] (96.00s)" or just the seconds
                const timeMatch = timestampText.match(/\(([0-9.]+)s\)/);
                if (timeMatch) {
                    const entryTime = parseFloat(timeMatch[1]);
                    const timeDiff = Math.abs(entryTime - targetTime);
                    if (timeDiff < closestTimeDiff) {
                        closestTimeDiff = timeDiff;
                        closestEntry = entry;
                    }
                }
            });
            
            // Scroll to the closest entry and highlight it
            if (closestEntry) {
                // Remove any existing highlights
                document.querySelectorAll('.transcript-entry').forEach(entry => {
                    entry.style.backgroundColor = '';
                    entry.style.borderLeft = '';
                });
                
                // Highlight the target entry
                closestEntry.style.backgroundColor = 'var(--light-surface-variant)';
                closestEntry.style.borderLeft = '4px solid var(--yt-red)';
                
                // Only switch to detailed view if we're not already there and didn't find a chapter anchor
                if (formattedDiv.style.display !== 'none') {
                    toggleTranscriptView();
                }
                
                // Scroll to the entry
                closestEntry.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                
                // Remove highlight after 3 seconds
                setTimeout(() => {
                    closestEntry.style.backgroundColor = '';
                    closestEntry.style.borderLeft = '';
                }, 3000);
            }
        }
        
    </script>
    
{% endblock %}