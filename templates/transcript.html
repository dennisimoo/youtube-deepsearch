{% extends "base.html" %}

{% block title %}{% if video_title %}{{ video_title }}{% else %}{{ video_id }}{% endif %} - YouTube Deep Search{% endblock %}

{% block content %}
    <!-- Video Header Card -->
    <div class="card video-info" style="margin-bottom: 24px;">
        <div class="card-body">
            <div style="display: flex; gap: 20px;">
                <div style="flex-shrink: 0;">
                    <img src="{{ thumbnail_url }}" 
                         alt="Video thumbnail" 
                         style="width: 320px; height: 180px; object-fit: cover; border-radius: 12px; border: 1px solid var(--border-light);"
                         onerror="this.style.display='none'">
                </div>
                <div style="flex-grow: 1; min-width: 0;">
                    {% if video_title %}
                        <h1 style="margin: 0 0 12px 0; font-size: 24px; font-weight: 700; line-height: 1.3; color: var(--text-primary);">{{ video_title }}</h1>
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px; color: var(--text-secondary);">
                            {% if video_uploader %}
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <i data-lucide="user" style="width: 16px; height: 16px;"></i>
                                    <a href="https://www.youtube.com/results?search_query={{ video_uploader|urlencode }}" target="_blank" style="color: var(--text-secondary); text-decoration: none; font-weight: 500;">{{ video_uploader }}</a>
                                </div>
                            {% endif %}
                            {% if video_duration %}
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <i data-lucide="clock" style="width: 16px; height: 16px;"></i>
                                    <span>{{ "%.0f"|format(video_duration // 60) }}:{{ "%02.0f"|format(video_duration % 60) }}</span>
                                </div>
                            {% endif %}
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <i data-lucide="file-text" style="width: 16px; height: 16px;"></i>
                                <span>{{ transcript|length }} entries</span>
                            </div>
                        </div>
                    {% else %}
                        <h1 style="margin: 0 0 16px 0; font-size: 24px; font-weight: 700; color: var(--text-primary);">Video ID: {{ video_id }}</h1>
                    {% endif %}
                    
                    <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                        <a href="https://www.youtube.com/watch?v={{ video_id }}" target="_blank" class="btn btn-primary">
                            <i data-lucide="play" class="btn-icon"></i>
                            Watch on YouTube
                        </a>
                        {% if summarize_enabled %}
                            <button id="generateSummaryBtn" onclick="generateSummary('{{ video_id }}')" class="btn btn-secondary" style="display: {% if summary %}none{% else %}inline-flex{% endif %};">
                                <i data-lucide="sparkles" class="btn-icon"></i>
                                Generate AI Summary
                            </button>
                        {% endif %}
                        <button onclick="toggleTranscriptView()" id="toggleBtn" class="btn btn-secondary">
                            <i data-lucide="book-open" class="btn-icon"></i>
                            Switch to Detailed View
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Summary section (full width, only shown when exists) -->
    {% if summary or summary_error %}
        <!-- Summary section -->
        <div id="summary-section" style="margin-bottom: 24px;">
            {% if summary %}
                <div class="card summary-section">
                    <div class="card-header">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0; display: flex; align-items: center; gap: 12px; font-size: 18px; font-weight: 600;">
                                <i data-lucide="sparkles" style="width: 20px; height: 20px; color: #8b5cf6;"></i>
                                AI-Generated Summary
                            </h3>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="copySummary()" class="btn btn-secondary" style="padding: 6px 12px; font-size: 14px;">
                                    <i data-lucide="copy" style="width: 14px; height: 14px;"></i>
                                    Copy
                                </button>
                                <button onclick="toggleSummary()" id="summaryToggleBtn" class="btn btn-secondary" style="padding: 6px 12px; font-size: 14px;">
                                    <i data-lucide="chevron-down" style="width: 14px; height: 14px;"></i>
                                    Expand
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="summary-content summary-collapsed" id="summaryContent">
                            <pre>{{ summary }}</pre>
                        </div>
                    </div>
                </div>
            {% endif %}
            
            {% if summary_error %}
                <div class="alert alert-warning">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <i data-lucide="alert-triangle" style="width: 16px; height: 16px;"></i>
                        <strong>Summary Generation Failed</strong>
                    </div>
                    <p style="margin: 0;">{{ summary_error }}</p>
                </div>
            {% endif %}
        </div>
    {% else %}
        <!-- Hidden summary section for AJAX loading -->
        <div id="summary-section" style="display: none;"></div>
    {% endif %}
    
    <!-- Chapters section (if any) -->
    {% if chapters %}
        <div class="card" style="margin-bottom: 24px;">
            <div class="card-header">
                <h4 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                    <i data-lucide="list" style="width: 16px; height: 16px; color: var(--yt-red);"></i>
                    Video Chapters ({{ chapters|length }})
                </h4>
            </div>
            <div class="card-body">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px;">
                    {% for chapter in chapters %}
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--light-surface); border-radius: 8px; border: 1px solid var(--border-light);">
                            <div style="font-weight: 500; color: var(--text-primary); font-size: 14px; flex: 1; margin-right: 8px;">{{ chapter.title }}</div>
                            <a href="https://www.youtube.com/watch?v={{ video_id }}&t={{ chapter.time|int }}s" target="_blank" class="btn btn-secondary" style="padding: 6px 10px; font-size: 12px;">
                                {{ "%.0f"|format(chapter.time // 60) }}:{{ "%02.0f"|format(chapter.time % 60) }}
                            </a>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    {% endif %}
    
    <!-- Transcript Content -->
    <div class="card">
        <div class="card-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; display: flex; align-items: center; gap: 12px; font-size: 18px; font-weight: 600;">
                    <i data-lucide="file-text" style="width: 20px; height: 20px; color: var(--yt-red);"></i>
                    Video Transcript ({{ transcript|length }} entries)
                </h3>
                <div style="display: flex; gap: 8px;">
                    <button onclick="copyTranscript()" class="btn btn-secondary" style="padding: 6px 12px; font-size: 14px;">
                        <i data-lucide="copy" style="width: 14px; height: 14px;"></i>
                        Copy
                    </button>
                    <button onclick="toggleTranscriptView()" id="toggleBtn2" class="btn btn-secondary" style="padding: 6px 12px; font-size: 14px;">
                        <i data-lucide="book-open" style="width: 14px; height: 14px;"></i>
                        Switch to Detailed View
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body" style="padding: 0;">
            <!-- Formatted readable transcript (default view) -->
            <div id="formatted-transcript" style="display: block;">
                <div style="background: var(--light-surface); padding: 24px; line-height: 1.8; font-family: Georgia, serif; font-size: 16px;">
                    <pre style="white-space: pre-wrap; font-family: Georgia, serif; margin: 0; color: var(--text-primary);">{{ formatted_transcript }}</pre>
                </div>
            </div>
            
            <!-- Detailed timestamp transcript (hidden by default) -->
            <div id="detailed-transcript" class="transcript-container" style="display: none;">
                {% for entry in transcript %}
                    <div class="transcript-entry">
                        <div class="timestamp">[{{ entry.formatted_time }}] ({{ "%.2f"|format(entry.time) }}s)</div>
                        <div class="text">{{ entry.text }}</div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <script>
        function toggleTranscriptView() {
            const formattedDiv = document.getElementById('formatted-transcript');
            const detailedDiv = document.getElementById('detailed-transcript');
            const toggleBtn = document.getElementById('toggleBtn');
            const toggleBtn2 = document.getElementById('toggleBtn2');
            
            if (formattedDiv.style.display === 'none') {
                // Show formatted, hide detailed
                formattedDiv.style.display = 'block';
                detailedDiv.style.display = 'none';
                
                if (toggleBtn) {
                    toggleBtn.innerHTML = '<i data-lucide="book-open" class="btn-icon"></i>Switch to Detailed View';
                }
                if (toggleBtn2) {
                    toggleBtn2.innerHTML = '<i data-lucide="book-open" style="width: 14px; height: 14px;"></i>Switch to Detailed View';
                }
            } else {
                // Show detailed, hide formatted
                formattedDiv.style.display = 'none';
                detailedDiv.style.display = 'block';
                
                if (toggleBtn) {
                    toggleBtn.innerHTML = '<i data-lucide="book-text" class="btn-icon"></i>Switch to Readable View';
                }
                if (toggleBtn2) {
                    toggleBtn2.innerHTML = '<i data-lucide="book-text" style="width: 14px; height: 14px;"></i>Switch to Readable View';
                }
            }
            
            // Reinitialize Lucide icons
            lucide.createIcons();
        }
        
        function generateSummary(videoId) {
            const btn = document.getElementById('generateSummaryBtn');
            const summarySection = document.getElementById('summary-section');
            
            // Get formatted transcript text (readable version, not detailed timestamps)
            const formattedTranscript = {{ formatted_transcript|tojson }};
            
            // Update button to show loading state
            btn.innerHTML = '<span class="spinner"></span> Generating...';
            btn.disabled = true;
            btn.classList.add('loading');
            
            // Make AJAX request to generate summary with formatted transcript
            fetch('/api/summary', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    video_id: videoId,
                    formatted_transcript: formattedTranscript
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Convert markdown links and formatting to HTML
                        let summaryHtml = data.summary;
                        // Convert [text](url) to <a href="url" target="_blank">text</a>
                        summaryHtml = summaryHtml.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color: var(--yt-red); text-decoration: underline;">$1</a>');
                        // Convert **text** to <strong>text</strong>
                        summaryHtml = summaryHtml.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
                        
                        
                        // Show summary section with new design
                        summarySection.style.display = 'block';
                        summarySection.style.marginBottom = '24px';
                        summarySection.innerHTML = `
                            <div class="card summary-section">
                                <div class="card-header">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <h3 style="margin: 0; display: flex; align-items: center; gap: 12px; font-size: 18px; font-weight: 600;">
                                            <i data-lucide="sparkles" style="width: 20px; height: 20px; color: #8b5cf6;"></i>
                                            AI-Generated Summary
                                        </h3>
                                        <div style="display: flex; gap: 8px;">
                                            <button onclick="copySummary()" class="btn btn-secondary" style="padding: 6px 12px; font-size: 14px;">
                                                <i data-lucide="copy" style="width: 14px; height: 14px;"></i>
                                                Copy
                                            </button>
                                            <button onclick="toggleSummary()" id="summaryToggleBtn" class="btn btn-secondary" style="padding: 6px 12px; font-size: 14px;">
                                                <i data-lucide="chevron-down" style="width: 14px; height: 14px;"></i>
                                                Expand
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="summary-content summary-collapsed" id="summaryContent">
                                        <pre style="white-space: pre-wrap; word-wrap: break-word; margin: 0; font-family: inherit; color: var(--text-primary);">${summaryHtml}</pre>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // Hide the generate button
                        btn.style.display = 'none';
                        
                        // Reinitialize Lucide icons
                        lucide.createIcons();
                    } else {
                        
                        // Show error
                        summarySection.style.display = 'block';
                        summarySection.style.marginBottom = '24px';
                        summarySection.innerHTML = `
                            <div class="alert alert-warning">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <i data-lucide="alert-triangle" style="width: 16px; height: 16px;"></i>
                                    <strong>Summary Generation Failed</strong>
                                </div>
                                <p style="margin: 0;">${data.error}</p>
                            </div>
                        `;
                        
                        // Reset button
                        btn.innerHTML = '<i data-lucide="sparkles" class="btn-icon"></i>Generate AI Summary';
                        btn.disabled = false;
                        btn.classList.remove('loading');
                        
                        // Reinitialize Lucide icons
                        lucide.createIcons();
                    }
                })
                .catch(error => {
                    
                    // Show error
                    summarySection.style.display = 'block';
                    summarySection.style.marginBottom = '24px';
                    summarySection.innerHTML = `
                        <div class="alert alert-warning">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <i data-lucide="alert-triangle" style="width: 16px; height: 16px;"></i>
                                <strong>Summary Generation Failed</strong>
                            </div>
                            <p style="margin: 0;">Failed to generate summary: ${error.message}</p>
                        </div>
                    `;
                    
                    // Reset button
                    btn.innerHTML = '<i data-lucide="sparkles" class="btn-icon"></i>Generate AI Summary';
                    btn.disabled = false;
                    btn.classList.remove('loading');
                    
                    // Reinitialize Lucide icons
                    lucide.createIcons();
                });
        }
        
        function copyTranscript() {
            // Get the currently visible transcript text
            const formattedDiv = document.getElementById('formatted-transcript');
            const detailedDiv = document.getElementById('detailed-transcript');
            
            let textToCopy = '';
            
            if (formattedDiv.style.display !== 'none') {
                // Copy formatted transcript (readable version)
                const preElement = formattedDiv.querySelector('pre');
                textToCopy = preElement ? preElement.textContent : '';
            } else {
                // Copy detailed transcript with timestamps
                const entries = detailedDiv.querySelectorAll('.transcript-entry');
                const lines = [];
                entries.forEach(entry => {
                    const timestamp = entry.querySelector('.timestamp').textContent;
                    const text = entry.querySelector('.text').textContent;
                    lines.push(`${timestamp} ${text}`);
                });
                textToCopy = lines.join('\n');
            }
            
            if (textToCopy) {
                copyToClipboard(textToCopy)
                    .then(() => {
                        showCopySuccess('Transcript copied to clipboard');
                    })
                    .catch(() => {
                        showCopyError();
                    });
            }
        }
        
        function copySummary() {
            const summaryElement = document.querySelector('#summaryContent pre');
            if (summaryElement) {
                const textToCopy = summaryElement.textContent;
                copyToClipboard(textToCopy)
                    .then(() => {
                        showCopySuccess('Summary copied to clipboard');
                    })
                    .catch(() => {
                        showCopyError();
                    });
            }
        }
        
        function showCopySuccess(message) {
            const content = `
                <div>
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; color: #22c55e;">
                        <i data-lucide="check" style="width: 16px; height: 16px;"></i>
                        <span style="font-weight: 500;">Copy Successful</span>
                    </div>
                    <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 6px; padding: 12px;">
                        <p style="margin: 0; color: var(--text-primary); font-size: 14px;">${message}</p>
                    </div>
                </div>
            `;
            showModal('statusModal', 'Copy Status', content);
        }
        
        function showCopyError() {
            const content = `
                <div>
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; color: #ef4444;">
                        <i data-lucide="alert-triangle" style="width: 16px; height: 16px;"></i>
                        <span style="font-weight: 500;">Copy Failed</span>
                    </div>
                    <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px; padding: 12px;">
                        <p style="margin: 0; color: var(--text-primary); font-size: 14px; line-height: 1.4;">Unable to copy to clipboard. Please select and copy the text manually.</p>
                    </div>
                </div>
            `;
            showModal('statusModal', 'Copy Status', content);
        }
        
        function toggleSummary() {
            const summaryContent = document.getElementById('summaryContent');
            const toggleBtn = document.getElementById('summaryToggleBtn');
            
            if (summaryContent.classList.contains('summary-collapsed')) {
                summaryContent.classList.remove('summary-collapsed');
                toggleBtn.innerHTML = '<i data-lucide="chevron-up" style="width: 14px; height: 14px;"></i> Collapse';
            } else {
                summaryContent.classList.add('summary-collapsed');
                toggleBtn.innerHTML = '<i data-lucide="chevron-down" style="width: 14px; height: 14px;"></i> Expand';
            }
            lucide.createIcons();
        }
        
    </script>
    
{% endblock %}